# 安全文档 / Security Documentation

## 概述

本文档详细说明了 chatData 应用的安全状况、已知漏洞、缓解措施和使用建议。

## 🔴 已知安全漏洞

### xlsx 库漏洞详情

#### 1. 正则表达式拒绝服务 (ReDoS)

**基本信息：**
- **漏洞 ID**: GHSA-5pgg-2g8v-p4x9
- **CVE**: 待分配
- **严重程度**: 高危 (High)
- **CVSS 评分**: 7.5
- **CVSS 向量**: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H

**影响范围：**
- 受影响版本：< 0.20.2
- 当前使用版本：0.18.5 ❌ 受影响
- 修复版本：0.20.2+ (npm 暂未发布)

**漏洞描述：**
SheetJS 中的正则表达式处理存在缺陷，攻击者可以构造特殊的 Excel 文件，触发正则表达式回溯，导致：
- CPU 使用率飙升
- 浏览器标签页无响应
- 拒绝服务 (DoS)

**攻击场景：**
1. 攻击者创建恶意构造的 Excel 文件
2. 用户上传该文件到应用
3. xlsx 库解析文件时触发 ReDoS
4. 浏览器标签页冻结或崩溃

#### 2. 原型污染 (Prototype Pollution)

**基本信息：**
- **漏洞 ID**: GHSA-4r6h-8v6p-xvw6
- **CVE**: 待分配
- **严重程度**: 高危 (High)
- **CVSS 评分**: 7.8
- **CVSS 向量**: CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H
- **CWE**: CWE-1321

**影响范围：**
- 受影响版本：< 0.19.3
- 当前使用版本：0.18.5 ❌ 受影响
- 修复版本：0.19.3+ (npm 暂未发布)

**漏洞描述：**
攻击者可以通过精心构造的 Excel 文件污染 JavaScript 原型链，可能导致：
- 执行任意代码
- 数据泄露
- 权限提升

**攻击场景：**
1. 攻击者创建包含特殊属性的 Excel 文件
2. 用户上传文件
3. xlsx 解析时污染 Object.prototype
4. 影响应用的其他部分，可能导致安全问题

## 🛡️ 已实施的安全措施

### 1. 用户界面层防护

**A. 安全警告横幅**
- 位置：页面顶部，紧跟 header
- 样式：红色背景，醒目设计
- 内容：明确说明 Excel 文件风险，推荐 CSV

**B. 上传确认对话框**
```javascript
Excel 文件上传时显示确认对话框：
- 说明存在安全漏洞
- 要求用户确认文件来源可信
- 提供取消选项
- 推荐使用 CSV 替代
```

### 2. 输入验证层防护

**A. 文件大小限制**
```javascript
MAX_FILE_SIZE: 10MB (10 * 1024 * 1024 bytes)
```
- 防止大文件导致内存溢出
- 减少 DoS 攻击影响

**B. 文件类型验证**
```javascript
ALLOWED_EXTENSIONS: ['csv', 'xlsx', 'xls']
```
- 白名单机制
- 防止上传其他类型文件

**C. 数据行数限制**
```javascript
MAX_ROWS: 10,000 行
```
- 超过限制时提示用户
- 用户可选择继续或取消

### 3. 文档层防护

**A. README 安全警告**
- 置顶显示安全警告部分
- 详细说明漏洞信息
- 提供使用建议和最佳实践

**B. 使用指南**
- 明确推荐 CSV 格式
- 说明 Excel 文件使用注意事项
- 提供安全检查清单

### 4. 应用架构防护

**A. 客户端处理**
- 所有文件在浏览器本地处理
- 不上传到服务器
- 限制漏洞影响范围

**B. 沙箱环境**
- 在浏览器沙箱中运行
- 无法访问操作系统资源
- 损害限制在当前标签页

## 📋 安全使用指南

### ✅ 推荐做法

1. **优先使用 CSV 格式**
   - Papa Parse 库安全可靠
   - 无已知安全漏洞
   - 解析速度快

2. **仅处理可信文件**
   - 自己创建的文件
   - 来自可信同事的文件
   - 组织内部系统导出的文件

3. **验证文件来源**
   - 确认发送者身份
   - 检查文件是否被篡改
   - 使用杀毒软件扫描

4. **转换 Excel 为 CSV**
   ```
   Excel → 另存为 → CSV (UTF-8)
   ```
   - 避免 Excel 解析风险
   - 保留数据，去除风险

### ❌ 禁止操作

1. **不要上传不明来源的 Excel 文件**
   - 邮件附件
   - 公开下载链接
   - 未知网站

2. **不要处理大型 Excel 文件**
   - > 10MB 的文件
   - > 10,000 行的数据
   - 复杂公式和宏

3. **不要忽视安全警告**
   - 仔细阅读警告内容
   - 理解潜在风险
   - 不确定时选择取消

## 🔄 漏洞修复计划

### 监控策略

**每周检查：**
```bash
npm view xlsx version
npm view xlsx time
```

**自动化监控：**
- 使用 GitHub Dependabot
- npm audit 定期检查
- 订阅 GHSA 通知

### 升级计划

**当 xlsx 发布修复版本 (0.19.3+ 或 0.20.2+) 时：**

1. **立即升级** (发现后 24 小时内)
   ```bash
   npm install xlsx@latest
   cp node_modules/xlsx/dist/xlsx.full.min.js lib/
   ```

2. **测试验证**
   - CSV 文件解析
   - Excel 文件解析
   - API 集成
   - UI 功能

3. **更新文档**
   - 移除安全警告
   - 更新版本信息
   - 通知用户

4. **发布更新**
   - 提交代码
   - 更新部署
   - 发布公告

### 临时替代方案

如果长期无法获得修复版本，考虑：

**选项 1：移除 Excel 支持**
- 仅保留 CSV 功能
- 提供 Excel 转 CSV 指南
- 完全消除风险

**选项 2：使用替代库**
- 研究其他 Excel 解析库
- 评估功能和安全性
- 进行迁移

**选项 3：服务端解析**
- 在安全的服务端环境解析
- 实施额外的安全措施
- 增加架构复杂度

## 🔍 安全审计日志

| 日期 | 操作 | 结果 |
|------|------|------|
| 2026-02-10 | CodeQL 扫描 | ✅ 通过 (0 个问题) |
| 2026-02-10 | npm audit | ⚠️ 1 个高危 (xlsx) |
| 2026-02-10 | 添加安全警告 | ✅ 完成 |
| 2026-02-10 | 实施文件验证 | ✅ 完成 |
| 2026-02-10 | 更新文档 | ✅ 完成 |

## 📞 报告安全问题

如果您发现新的安全问题：

1. **不要公开披露**
2. **通过 GitHub Security Advisory 私密报告**
3. **提供详细信息**：
   - 漏洞描述
   - 重现步骤
   - 影响范围
   - 建议修复方案

## 📚 参考资源

- [GHSA-5pgg-2g8v-p4x9](https://github.com/advisories/GHSA-5pgg-2g8v-p4x9) - ReDoS 漏洞
- [GHSA-4r6h-8v6p-xvw6](https://github.com/advisories/GHSA-4r6h-8v6p-xvw6) - 原型污染漏洞
- [SheetJS GitHub](https://github.com/SheetJS/sheetjs) - 官方仓库
- [OWASP Top 10](https://owasp.org/www-project-top-ten/) - Web 安全最佳实践

## ⚖️ 风险评估

### 风险等级：中等 (Medium)

**理由：**
- ✅ 漏洞严重但可控
- ✅ 已实施多层防护
- ✅ 用户充分告知
- ✅ 客户端环境限制影响
- ⚠️ 依赖第三方库更新

### 建议：

**对于普通用户：**
- 使用 CSV 格式
- 仅处理可信文件
- 遵循安全指南

**对于企业用户：**
- 评估风险是否可接受
- 考虑仅部署 CSV 功能
- 等待库更新后再启用 Excel

---

**文档版本**: 1.0  
**最后更新**: 2026-02-10  
**下次审查**: 2026-02-17 (每周)
